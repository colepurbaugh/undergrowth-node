<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schedule Events</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #333;
            --text-primary: #e8e6e3;
            --text-secondary: #a8a8a8;
            --border-color: #444;
            --success-color: #3d8c40;
            --error-color: #a91409;
            --active-color: #998100;
            --inactive-color: #4f5559;
            --selection-bg: #004daa;
            --selection-text: #e8e6e3;
            --emergency-button-color: #ff6b00;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--bg-primary);
            background-image: url('/assets/backgrounds/undergrowth_logo.png');
            background-repeat: no-repeat;
            background-position: top center;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 1rem;
            min-height: 100vh;
        }

        .container {
            background-color: var(--bg-primary);
            background: none;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            width: 100%;
        }

        .event-control {
            display: flex;
            opacity: 0.8;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #333;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        .controls-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .gpio-title {
            font-family: monospace;
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: bold;
            min-width: 50px;
            margin-right: 0.5rem;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 80px;
            padding: 0.25rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        .pwm-value {
            color: var(--text-secondary);
            min-width: 40px;
        }

        button {
            padding: 0.25rem 0.5rem;
            background-color: var(--inactive-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            cursor: pointer;
        }

        button:hover {
            background-color: var(--active-color);
        }

        button.delete {
            margin-left: 1rem;
            background-color: var(--error-color);
            padding: 0.4rem 0.75rem;
        }

        button.add-event {
            margin-left: auto;
            background-color: var(--success-color);
            padding: 0.4rem 0.75rem;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--inactive-color);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-primary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(36px);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .header-row h2 {
            margin-bottom: 0;
        }

        .header-title {
            font-size: 1.6rem;
            font-weight: semibold;
            color: var(--text-primary);
        }

        .mode-label {
            color: var(--text-primary);
            font-size: 1rem;
        }

        .mode-slider {
            background-color: var(--error-color);
        }

        .mode-toggle input:checked + .slider {
            background-color: var(--selection-bg);
        }

        .mode-slider.automatic {
            background-color: var(--selection-bg);
        }

        /* Clock styles */
        .clock {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            background: none;
            /*background-color: var(--bg-primary);*/
        }

        /* Emergency Stop styles */
        .emergency-button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background-color: var(--error-color);
            color: var(--text-primary);
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .emergency-button:hover {
            background-color: #c0110b;
        }

        .emergency-button.emergency-active {
            background-color: #ff6b00;
        }

        body.emergency-stop-active {
            background-color: var(--error-color);
            opacity: 0.1;
        }

        /* Countdown timer styles */
        .countdown {
            font-family: monospace;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        /* Active schedule indicator */
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            margin: 1rem;
            margin-left: 0;
            margin-right: 0;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background-color: #333;
            opacity: 0.8;
        }

        .event-item.active {
            background-color: var(--active-color) !important;
        }

        .event-item > * {
            flex: 0 1 auto;
        }

        .event-item .event-time {
            flex: 0 1 auto;
            min-width: 100px;
        }

        .event-item .event-pwm {
            flex: 0 1 auto;
            min-width: 80px;
        }

        .event-item .event-gpio {
            flex: 0 1 auto;
            min-width: 80px;
        }

        .event-item .toggle-switch {
            flex: 0 0 auto;
        }

        .event-item button {
            flex: 0 0 auto;
        }

        .gpio-title-12 { color: #ffeb3b; } /* yellow */
        .gpio-title-13 { color: #2196f3; } /* blue */
        .gpio-title-18 { color: #f44336; } /* red */
        .gpio-title-19 { color: #4caf50; } /* green */

        .event-time {
            font-family: monospace;
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        .event-pwm {
            font-family: monospace;
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        .event-enabled {
            margin-left: auto;
        }

        .event-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #333;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        .event-controls > * {
            flex: 0 1 auto;
        }

        .event-controls .time-input {
            flex: 0 1 auto;
            min-width: 120px;
        }

        .event-controls .pwm-input {
            flex: 0 1 auto;
            min-width: 100px;
        }

        .event-controls .gpio-select {
            flex: 0 1 auto;
            min-width: 100px;
        }

        .event-controls button {
            flex: 0 0 auto;
        }

        .active-events {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with title, clock, mode toggle, and emergency stop -->
        <div class="header-row">
            <h2 class="header-title">Add Event</h2>
            <div class="clock" id="clock">00:00:00</div>
            <div class="toggle-container">
                <span class="mode-label">manual</span>
                <label class="toggle mode-toggle">
                    <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                    <span class="slider mode-slider"></span>
                </label>
                <span class="mode-label">automatic</span>
                <button class="emergency-button" id="emergencyButton" onclick="toggleEmergencyStop()">Emergency Stop</button>
            </div>
        </div>

        <!-- Add New Event Form -->
        <div class="event-control">
            <span class="gpio-title">GPIO:</span>
            <select id="gpio">
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="18">18</option>
                <option value="19">19</option>
            </select>
            <span class="gpio-title">Time:</span>
            <input type="text" id="triggerTime" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" placeholder="HH:MM:SS">
            <span class="gpio-title">PWM:</span>
            <input type="number" id="pwmValue" min="0" max="1024" value="0">
            <span class="pwm-value">/1024</span>
            <button class="add-event" onclick="addEvent()">Add Event</button>
        </div>

        <!-- Active Events List -->
        <div class="header-row">
            <h2 class="text-xl font-semibold mb-4 text-[#e8e6e3]">Active Events</h2>
        </div>
        <div id="eventList">
            <!-- Events will be dynamically populated here -->
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let emergencyStopActive = false;
        let currentTimezone = 'America/Los_Angeles'; // Default, will be updated from server

        // Clock functionality
        function updateClock() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const timeString = formatter.format(now);
            const timezoneAbbr = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                timeZoneName: 'short'
            }).formatToParts(now).find(part => part.type === 'timeZoneName').value;
            document.getElementById('clock').textContent = `${timeString} (${timezoneAbbr})`;
        }

        // Update clock every second
        setInterval(updateClock, 1000);
        updateClock(); // Initial update

        // Emergency Stop functionality
        function toggleEmergencyStop() {
            const button = document.getElementById('emergencyButton');
            if (emergencyStopActive) {
                socket.emit('clearEmergencyStop');
                button.textContent = 'Emergency Stop';
                button.classList.remove('emergency-active');
                document.body.style.backgroundColor = 'var(--bg-primary)';
                emergencyStopActive = false;
            } else {
                socket.emit('emergencyStop');
                button.textContent = 'Clear Emergency';
                button.classList.add('emergency-active');
                document.body.style.backgroundColor = 'var(--error-color)';
                emergencyStopActive = true;
            }
        }

        // Countdown timer functionality
        function updateCountdown(index, triggerTime) {
            const countdownElement = document.getElementById(`countdown-${index}`);
            if (!countdownElement) return;

            const now = new Date();
            const [hours, minutes, seconds] = triggerTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(hours, minutes, seconds);

            if (target < now) {
                target.setDate(target.getDate() + 1);
            }

            const diff = target - now;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);

            countdownElement.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateAllCountdowns() {
            const events = document.querySelectorAll('.event-item');
            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            // Find active events for each GPIO, only considering enabled events
            const activeEvents = {};
            events.forEach(event => {
                const time = event.querySelector('.event-time').textContent;
                const [hours, minutes, seconds] = time.split(':').map(Number);
                const eventTime = hours * 3600 + minutes * 60 + seconds;
                const gpio = event.querySelector('.event-gpio').textContent.replace('GPIO', '');
                const isEnabled = event.querySelector('.event-enabled input').checked;
                
                if (!isEnabled) return; // Skip disabled events
                
                if (!activeEvents[gpio] || 
                    (eventTime <= currentTime && eventTime > (activeEvents[gpio].time || -1)) ||
                    (eventTime > currentTime && eventTime < (activeEvents[gpio].time || Infinity))) {
                    activeEvents[gpio] = {
                        time: eventTime,
                        event: event
                    };
                }
            });

            // Update active states
            events.forEach(event => {
                const gpio = event.querySelector('.event-gpio').textContent.replace('GPIO', '');
                const isActive = activeEvents[gpio] && activeEvents[gpio].event === event;
                event.classList.toggle('active', isActive);
            });

            // Update countdowns
            events.forEach(event => {
                const index = event.dataset.index;
                const time = event.querySelector('.event-time').textContent;
                updateCountdown(index, time);
            });
        }

        // Update countdowns every second
        setInterval(updateAllCountdowns, 1000);

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('getInitialState');
            socket.emit('getTimezone');  // Request timezone
        });

        socket.on('initialState', (data) => {
            console.log('Received initial state:', data);
            updateUI(data);
        });

        socket.on('stateUpdate', (data) => {
            console.log('Received state update:', data);
            updateUI(data);
        });

        socket.on('emergencyStop', () => {
            const button = document.getElementById('emergencyButton');
            button.textContent = 'Clear Emergency';
            button.classList.add('emergency-active');
            document.body.style.backgroundColor = 'var(--error-color)';
            emergencyStopActive = true;
        });

        socket.on('clearEmergencyStop', () => {
            const button = document.getElementById('emergencyButton');
            button.textContent = 'Emergency Stop';
            button.classList.remove('emergency-active');
            document.body.style.backgroundColor = 'var(--bg-primary)';
            emergencyStopActive = false;
        });

        // Handle events update
        socket.on('eventsUpdated', (events) => {
            console.log('Received events update:', events);
            updateEventDisplay(events);
        });

        // Handle mode toggle
        function toggleMode() {
            const modeToggle = document.getElementById('modeToggle');
            const newMode = modeToggle.checked ? 0 : 1;
            socket.emit('setMode', { automatic: modeToggle.checked });
            console.log('Client: Toggling mode to:', newMode);
        }

        // Handle mode update
        socket.on('modeUpdate', (data) => {
            console.log('Client: Received mode update:', data);
            const modeToggle = document.getElementById('modeToggle');
            modeToggle.checked = data.mode === 0;
            updateModeDisplay();
        });

        // Event handling functions
        function validateTime(timeStr) {
            // Check format
            if (!/^\d{2}:\d{2}:\d{2}$/.test(timeStr)) {
                alert('Time must be in HH:MM:SS format');
                return false;
            }

            const [hours, minutes, seconds] = timeStr.split(':').map(Number);

            // Check ranges
            if (hours < 0 || hours > 23) {
                alert('Hours must be between 00 and 23');
                return false;
            }
            if (minutes < 0 || minutes > 59) {
                alert('Minutes must be between 00 and 59');
                return false;
            }
            if (seconds < 0 || seconds > 59) {
                alert('Seconds must be between 00 and 59');
                return false;
            }

            return true;
        }

        function validatePwm(pwm) {
            const pwmNum = Number(pwm);
            if (isNaN(pwmNum) || pwmNum < 0 || pwmNum > 1024) {
                alert('PWM value must be between 0 and 1024');
                return false;
            }
            return true;
        }

        function addEvent() {
            const gpio = document.getElementById('gpio').value;
            const time = document.getElementById('triggerTime').value;
            const pwm = document.getElementById('pwmValue').value;
            
            if (!time) {
                alert('Please enter a time');
                return;
            }
            
            if (!validateTime(time)) {
                return;
            }

            if (!validatePwm(pwm)) {
                return;
            }

            socket.emit('addEvent', { 
                gpio: parseInt(gpio), 
                time, 
                pwm_value: parseInt(pwm), 
                enabled: 1 
            });
        }

        function updateEventDisplay(events) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            // Find active events for each GPIO, only considering enabled events
            const activeEvents = {};
            events.forEach(event => {
                if (!event.enabled) return; // Skip disabled events

                const [hours, minutes, seconds] = event.time.split(':').map(Number);
                const eventTime = hours * 3600 + minutes * 60 + seconds;
                
                if (!activeEvents[event.gpio] || 
                    (eventTime <= currentTime && eventTime > (activeEvents[event.gpio].time || -1)) ||
                    (eventTime > currentTime && eventTime < (activeEvents[event.gpio].time || Infinity))) {
                    activeEvents[event.gpio] = {
                        time: eventTime,
                        event: event
                    };
                }
            });

            // Create event items
            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.dataset.index = event.id;

                // Check if this is an active event
                const isActive = activeEvents[event.gpio] && activeEvents[event.gpio].event.id === event.id;
                if (isActive) {
                    eventDiv.classList.add('active');
                }

                const percentage = Math.round((event.pwm_value / 1024) * 100);
                eventDiv.innerHTML = `
                    <span class="event-gpio">GPIO${event.gpio}</span>
                    <span class="event-time">${event.time}</span>
                    <span class="event-pwm">${event.pwm_value}/1024 ${percentage}%</span>
                    <span class="countdown" id="countdown-${event.id}"></span>
                    <label class="toggle event-enabled">
                        <input type="checkbox" ${event.enabled ? 'checked' : ''} 
                               onchange="toggleEvent(${event.id}, this.checked)">
                        <span class="slider"></span>
                    </label>
                    <button class="delete" onclick="deleteEvent(${event.id})">Delete</button>
                `;

                eventList.appendChild(eventDiv);
                updateCountdown(event.id, event.time);
            });
        }

        function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                socket.emit('deleteEvent', { id });
            }
        }

        function toggleEvent(id, enabled) {
            socket.emit('toggleEvent', { id, enabled });
        }

        function updateUI(data) {
            updateEventDisplay(data.events);
            // Add countdown elements to each event
            const events = document.querySelectorAll('.event-item');
            events.forEach(event => {
                const index = event.dataset.index;
                const time = event.querySelector('.event-time').textContent;
                const countdownElement = document.createElement('div');
                countdownElement.id = `countdown-${index}`;
                countdownElement.className = 'countdown';
                event.appendChild(countdownElement);
                updateCountdown(index, time);
            });
        }

        socket.on('timezoneUpdate', (data) => {
            currentTimezone = data.timezone;
            updateClock();
        });
    </script>
</body>
</html>
