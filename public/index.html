<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undergrowth Node</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <style>
        :root {
            --bg-primary: #181a1b;
            --text-primary: #e8e6e3;
            --text-secondary: #b2aba1;
            --border-color: #736b5e;
            --success-color: #3d8c40;
            --error-color: #a91409;
            --active-color: #998100;
            --inactive-color: #4f5559;
            --selection-bg: #004daa;
            --selection-text: #e8e6e3;
            --emergency-color: #ff8c00;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--bg-primary);
            background-image: url('/assets/backgrounds/undergrowth_logo.png');
            background-repeat: no-repeat;
            background-position: top center;
            background-size: 100vw auto;
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 1rem;
            min-height: 100vh;
        }

        ::selection {
            background-color: var(--selection-bg);
            color: var(--selection-text);
        }

        h2, h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .container {
            background-color: var(--bg-primary);
            background: none;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            width: 100%;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header-row h2 {
            margin-bottom: 0;
        }

        .emergency-button {
            padding: 0.5rem 1rem;
            background-color: var(--error-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: bold;
        }

        .emergency-button:hover {
            background-color: #c0110b;
        }

        .info-section {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .info-item {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            background-color: #333;
            opacity: 0.8;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        .info-label {
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: var(--text-primary);
            font-family: monospace;
            font-size: 1.1rem;
        }

        .nav-buttons {
            display: flex;
            opacity: 0.8;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background-color: #333;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        .nav-button {
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0.25rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .nav-button:hover {
            opacity: 0.8;
        }

        .nav-button.schedule {
            background-color: #2196f3; /* blue */
        }

        .nav-button.pwm {
            background-color: #f44336; /* red */
        }

        .nav-button.graph {
            background-color: #9c27b0; /* purple */
        }

        .timezone-section {
            background-color: #333;
            opacity: 0.8;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clock-display {
            font-family: monospace;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            flex-direction: row;
            gap: 0.25rem;
            align-items: center;
        }

        .clock-time {
            font-size: 1.5rem;
        }

        .clock-timezone {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .timezone-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        #timezoneSelect {
            padding: 0.5rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }

        #updateTimezone {
            padding: 0.5rem 1rem;
            background-color: var(--success-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            cursor: pointer;
        }

        #updateTimezone:hover {
            opacity: 0.8;
        }

        @media (max-width: 600px) {
            body {
                padding: 0.5rem;
            }

            .container {
                padding: 0.5rem;
            }

            .info-item {
                min-width: 100%;
            }
        }

        .state-display {
            margin: 20px;
            padding: 10px;
            opacity: 0.8;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .state-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .state-section {
            flex: 1;
            padding: 10px;
            opacity: 0.8;
            border: 1px solid var(--border-color);
            background: #333;
        }

        .state-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .state-section div {
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .schedule-event {
            margin-left: 0;
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h2 class="text-xl font-semibold mb-4 text-[#e8e6e3]">System Information</h2>
            <button id="emergencyButton" class="emergency-button" onclick="toggleEmergencyStop()">Emergency Stop</button>
        </div>
        <div class="timezone-section">
            <div class="clock-display">
                <span id="dateDisplay"></span>
                <span id="timeDisplay"></span>
                <span id="timezoneDisplay"></span>
            </div>
            <div class="timezone-controls">
                <select id="timezoneSelect">
                    <!-- US Timezones -->
                    <option value="America/New_York">ET</option>
                    <option value="America/Chicago">CT</option>
                    <option value="America/Denver">MT</option>
                    <option value="America/Los_Angeles">PT</option>
                    <option value="America/Anchorage">AKT</option>
                    <option value="Pacific/Honolulu">HT</option>
                    <!-- UTC Offsets -->
                    <option value="UTC">UTC</option>
                    <option value="UTC+1">UTC+1</option>
                    <option value="UTC+2">UTC+2</option>
                    <option value="UTC+3">UTC+3</option>
                    <option value="UTC+4">UTC+4</option>
                    <option value="UTC+5">UTC+5</option>
                    <option value="UTC+6">UTC+6</option>
                    <option value="UTC+7">UTC+7</option>
                    <option value="UTC+8">UTC+8</option>
                    <option value="UTC+9">UTC+9</option>
                    <option value="UTC+10">UTC+10</option>
                    <option value="UTC+11">UTC+11</option>
                    <option value="UTC+12">UTC+12</option>
                    <option value="UTC-1">UTC-1</option>
                    <option value="UTC-2">UTC-2</option>
                    <option value="UTC-3">UTC-3</option>
                    <option value="UTC-4">UTC-4</option>
                    <option value="UTC-5">UTC-5</option>
                    <option value="UTC-6">UTC-6</option>
                    <option value="UTC-7">UTC-7</option>
                    <option value="UTC-8">UTC-8</option>
                    <option value="UTC-9">UTC-9</option>
                    <option value="UTC-10">UTC-10</option>
                    <option value="UTC-11">UTC-11</option>
                    <option value="UTC-12">UTC-12</option>
                </select>
                <button id="updateTimezone">Update Timezone</button>
            </div>
        </div>
    
        <div class="nav-buttons">
            <a href="/schedule" class="nav-button schedule">Schedule</a>
            <a href="/pwm" class="nav-button pwm">PWM</a>
            <a href="/graph" class="nav-button graph">Graph</a>
        </div>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Pi Uptime:</div>
                <div class="info-value" id="piUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Server Uptime:</div>
                <div class="info-value" id="serverUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">IP Address:</div>
                <div class="info-value" id="ipAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">MAC Address:</div>
                <div class="info-value" id="macAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Hostname:</div>
                <div class="info-value" id="hostname">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">CPU Temperature:</div>
                <div class="info-value" id="cpuTemp">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>AHT10 Sensor 1</h2>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">I2C Address:</div>
                <div class="info-value" id="sensor1Address">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Temperature:</div>
                <div class="info-value" id="sensor1Temp">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Humidity:</div>
                <div class="info-value" id="sensor1Humidity">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>AHT10 Sensor 2</h2>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">I2C Address:</div>
                <div class="info-value" id="sensor2Address">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Temperature:</div>
                <div class="info-value" id="sensor2Temp">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Humidity:</div>
                <div class="info-value" id="sensor2Humidity">Loading...</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSafetyState = {
            emergency_stop: false,
            normal_enable: true
        };

        // Request initial state when page loads
        socket.emit('getInitialState');

        // Handle initial state
        socket.on('initialState', (data) => {
            if (data && data.safety) {
                currentSafetyState = data.safety;
                updateSafetyUI();
            }
        });

        // Handle safety state updates
        socket.on('safetyStateUpdate', (data) => {
            if (data) {
                currentSafetyState = data;
                updateSafetyUI();
            }
        });

        function updateSafetyUI() {
            const emergencyButton = document.getElementById('emergencyButton');
            if (!emergencyButton) return; // Safety check
            
            if (currentSafetyState && currentSafetyState.emergency_stop) {
                emergencyButton.textContent = 'Clear Emergency Stop';
                document.body.style.backgroundColor = 'var(--error-color)';
            } else {
                emergencyButton.textContent = 'Emergency Stop';
                document.body.style.backgroundColor = 'var(--bg-primary)';
            }
        }

        // Event handler for the emergency button
        document.getElementById('emergencyButton').addEventListener('click', () => {
            if (currentSafetyState && currentSafetyState.emergency_stop) {
                socket.emit('clearEmergencyStop');
            } else {
                socket.emit('emergencyStop');
            }
        });

        socket.on('sensorData', (data) => {
            // Update system information
            document.getElementById('piUptime').textContent = data.system.piUptime;
            document.getElementById('serverUptime').textContent = data.system.serverUptime;
            document.getElementById('ipAddress').textContent = data.system.ipAddress;
            document.getElementById('macAddress').textContent = data.system.macAddress;
            document.getElementById('hostname').textContent = data.system.hostname;
            document.getElementById('cpuTemp').textContent = data.system.cpuTemp;

            // Update sensor 1 information
            document.getElementById('sensor1Address').textContent = data.sensor1.address;
            document.getElementById('sensor1Temp').textContent = data.sensor1.temperature;
            document.getElementById('sensor1Humidity').textContent = `${data.sensor1.humidity.toFixed(1)}%`;

            // Update sensor 2 information
            document.getElementById('sensor2Address').textContent = data.sensor2.address;
            document.getElementById('sensor2Temp').textContent = data.sensor2.temperature;
            document.getElementById('sensor2Humidity').textContent = `${data.sensor2.humidity.toFixed(1)}%`;
        });

        // Clock and timezone handling
        let currentTimezone = 'America/Los_Angeles';
        
        function updateClock() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZoneName: 'short'
            });
            
            const parts = formatter.formatToParts(now);
            const date = parts.find(p => p.type === 'month').value + ' ' +
                        parts.find(p => p.type === 'day').value + ' ' +
                        parts.find(p => p.type === 'year').value;
            const time = parts.find(p => p.type === 'hour').value + ':' +
                        parts.find(p => p.type === 'minute').value + ':' +
                        parts.find(p => p.type === 'second').value;
            const timezone = parts.find(p => p.type === 'timeZoneName').value;
            
            document.getElementById('dateDisplay').textContent = date + ', ';
            document.getElementById('timeDisplay').textContent = time;
            document.getElementById('timezoneDisplay').textContent = ' (' + timezone + ')';
        }

        // Update clock every second
        setInterval(updateClock, 1000);
        updateClock(); // Initial update

        // Request initial timezone when connecting
        socket.on('connect', () => {
            socket.emit('getTimezone');
        });

        // Handle timezone updates
        socket.on('timezoneUpdate', (data) => {
            const { timezone } = data;
            const timezoneSelect = document.getElementById('timezoneSelect');
            timezoneSelect.value = timezone;
            currentTimezone = timezone;
            updateClock();
        });

        // Update timezone button click handler
        document.getElementById('updateTimezone').addEventListener('click', () => {
            const timezone = timezoneSelect.value;
            socket.emit('setTimezone', { timezone });
        });

        document.getElementById('retrieve-values-btn').addEventListener('click', function() {
            socket.emit('getSystemState');
        });

        socket.on('systemState', function(data) {
            console.log('Received system state:', data);
            
            // Update modes
            document.getElementById('mode-auto').textContent = data.modes.automatic ? '1' : '0';
            document.getElementById('mode-emergency').textContent = data.modes.emergency ? '1' : '0';

            // Update manual PWM
            Object.entries(data.manualPwm).forEach(([pin, state]) => {
                const element = document.getElementById(`manual-${pin}`);
                if (element) {
                    element.textContent = `{${state.value}, ${state.enabled}}`;
                }
            });

            // Update automatic PWM
            Object.entries(data.autoPwm).forEach(([pin, value]) => {
                const element = document.getElementById(`auto-${pin}`);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update schedule
            console.log('Schedule data:', data.schedule);
            Object.entries(data.schedule).forEach(([pin, events]) => {
                console.log(`Processing pin ${pin}:`, events);
                const element = document.getElementById(`schedule-${pin}`);
                if (element) {
                    if (events.length === 0) {
                        element.textContent = '-';
                    } else {
                        element.innerHTML = events.map(event => 
                            `<div class="schedule-event ${event.enabled ? 'enabled' : 'disabled'}">
                                {"${event.time}", ${event.value}, ${event.enabled}}
                            </div>`
                        ).join('');
                    }
                }
            });
        });

        // Also update on state changes
        socket.on('stateUpdate', function() {
            socket.emit('getSystemState');
        });

        socket.on('modeUpdate', function() {
            socket.emit('getSystemState');
        });
    </script>
</body>
</html> 