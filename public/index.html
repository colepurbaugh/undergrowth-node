<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undergrowth Node</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h2 class="text-xl font-semibold mb-4 text-[#e8e6e3]">System Information</h2>
            <button id="emergencyButton" class="emergency-button">Emergency Stop</button>
        </div>
        <div class="timezone-section">
            <div class="clock-display">
                <span id="dateDisplay"></span>
                <span id="timeDisplay"></span>
                <span id="timezoneDisplay"></span>
            </div>
            <div class="timezone-controls">
                <select id="timezoneSelect">
                    <!-- US Timezones -->
                    <option value="America/New_York">ET</option>
                    <option value="America/Chicago">CT</option>
                    <option value="America/Denver">MT</option>
                    <option value="America/Los_Angeles">PT</option>
                    <option value="America/Anchorage">AKT</option>
                    <option value="Pacific/Honolulu">HT</option>
                    <!-- UTC Offsets -->
                    <option value="UTC">UTC</option>
                    <option value="UTC+1">UTC+1</option>
                    <option value="UTC+2">UTC+2</option>
                    <option value="UTC+3">UTC+3</option>
                    <option value="UTC+4">UTC+4</option>
                    <option value="UTC+5">UTC+5</option>
                    <option value="UTC+6">UTC+6</option>
                    <option value="UTC+7">UTC+7</option>
                    <option value="UTC+8">UTC+8</option>
                    <option value="UTC+9">UTC+9</option>
                    <option value="UTC+10">UTC+10</option>
                    <option value="UTC+11">UTC+11</option>
                    <option value="UTC+12">UTC+12</option>
                    <option value="UTC-1">UTC-1</option>
                    <option value="UTC-2">UTC-2</option>
                    <option value="UTC-3">UTC-3</option>
                    <option value="UTC-4">UTC-4</option>
                    <option value="UTC-5">UTC-5</option>
                    <option value="UTC-6">UTC-6</option>
                    <option value="UTC-7">UTC-7</option>
                    <option value="UTC-8">UTC-8</option>
                    <option value="UTC-9">UTC-9</option>
                    <option value="UTC-10">UTC-10</option>
                    <option value="UTC-11">UTC-11</option>
                    <option value="UTC-12">UTC-12</option>
                </select>
                <button id="updateTimezone">Update Timezone</button>
            </div>
        </div>
    
        <div class="nav-buttons">
            <a href="/schedule" class="nav-button schedule">Schedule</a>
            <a href="/pwm" class="nav-button pwm">PWM</a>
            <a href="/graph" class="nav-button graph">Graph</a>
        </div>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Pi Uptime:</div>
                <div class="info-value" id="piUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Server Uptime:</div>
                <div class="info-value" id="serverUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">IP Address:</div>
                <div class="info-value" id="ipAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">MAC Address:</div>
                <div class="info-value" id="macAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Hostname:</div>
                <div class="info-value" id="hostname">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">CPU Temperature:</div>
                <div class="info-value" id="cpuTemp">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>AHT10 Sensor 1</h2>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">I2C Address:</div>
                <div class="info-value" id="sensor1Address">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Temperature:</div>
                <div class="info-value" id="sensor1Temp">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Humidity:</div>
                <div class="info-value" id="sensor1Humidity">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>AHT10 Sensor 2</h2>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">I2C Address:</div>
                <div class="info-value" id="sensor2Address">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Temperature:</div>
                <div class="info-value" id="sensor2Temp">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Humidity:</div>
                <div class="info-value" id="sensor2Humidity">Loading...</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSafetyState = {
            emergency_stop: false,
            normal_enable: true
        };

        // Clock and timezone handling
        let currentTimezone = 'America/Los_Angeles';
        
        function updateClock() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZoneName: 'short'
            });
            
            const parts = formatter.formatToParts(now);
            const date = parts.find(p => p.type === 'month').value + ' ' +
                        parts.find(p => p.type === 'day').value + ' ' +
                        parts.find(p => p.type === 'year').value;
            const time = parts.find(p => p.type === 'hour').value + ':' +
                        parts.find(p => p.type === 'minute').value + ':' +
                        parts.find(p => p.type === 'second').value;
            const timezone = parts.find(p => p.type === 'timeZoneName').value;
            
            const dateDisplay = document.getElementById('dateDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            const timezoneDisplay = document.getElementById('timezoneDisplay');
            
            if (dateDisplay && timeDisplay && timezoneDisplay) {
                dateDisplay.textContent = date + ', ';
                timeDisplay.textContent = time;
                timezoneDisplay.textContent = ' (' + timezone + ')';
            }
        }

        // Move all initialization code into a DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            // Update clock every second
            setInterval(updateClock, 1000);
            updateClock(); // Initial update

            // Apply current safety state to UI immediately
            updateSafetyUI();

            // Emergency Stop functionality
            const emergencyButton = document.getElementById('emergencyButton');
            if (emergencyButton) {
                emergencyButton.addEventListener('click', () => {
                    if (emergencyButton.textContent === 'Emergency Stop') {
                        socket.emit('emergencyStop');
                        emergencyButton.textContent = 'Clear Emergency';
                        emergencyButton.classList.add('emergency-active');
                    } else {
                        socket.emit('clearEmergencyStop');
                        emergencyButton.textContent = 'Emergency Stop';
                        emergencyButton.classList.remove('emergency-active');
                    }
                });
            }

            // Timezone update button
            const updateTimezoneButton = document.getElementById('updateTimezone');
            if (updateTimezoneButton) {
                updateTimezoneButton.addEventListener('click', () => {
                    const timezoneSelect = document.getElementById('timezoneSelect');
                    if (timezoneSelect) {
                        const timezone = timezoneSelect.value;
                        socket.emit('setTimezone', { timezone });
                    }
                });
            }

            // Retrieve values button
            const retrieveValuesBtn = document.getElementById('retrieve-values-btn');
            if (retrieveValuesBtn) {
                retrieveValuesBtn.addEventListener('click', function() {
                    socket.emit('getSystemState');
                });
            }

            // Request initial state
            socket.emit('getInitialState');
        });

        // Handle timezone updates
        socket.on('timezoneUpdate', (data) => {
            const { timezone } = data;
            const timezoneSelect = document.getElementById('timezoneSelect');
            if (timezoneSelect) {
                timezoneSelect.value = timezone;
            }
            currentTimezone = timezone;
            updateClock();
        });

        // Handle initial state
        socket.on('initialState', (data) => {
            console.log('Received initial state:', data);
            
            // Handle safety state - proper conversion of numeric values to boolean
            if (data.safetyStates) {
                console.log('Found safety data in initialState:', data.safetyStates);
                // Convert number values to boolean for UI consistency
                currentSafetyState = {
                    emergency_stop: data.safetyStates.emergency_stop === 1,
                    normal_enable: data.safetyStates.normal_enable === 1
                };
                updateSafetyUI();
            } else if (data && data.safety) {
                currentSafetyState = data.safety;
                updateSafetyUI();
            }

            // Update system information and other data handling remains unchanged
            if (data.system) {
                document.getElementById('piUptime').textContent = data.system.piUptime;
                document.getElementById('serverUptime').textContent = data.system.serverUptime;
                document.getElementById('ipAddress').textContent = data.system.ipAddress;
                document.getElementById('macAddress').textContent = data.system.macAddress;
                document.getElementById('hostname').textContent = data.system.hostname;
                document.getElementById('cpuTemp').textContent = data.system.cpuTemp;
            }

            if (data.sensor1) {
                document.getElementById('sensor1Address').textContent = data.sensor1.address;
                document.getElementById('sensor1Temp').textContent = data.sensor1.temperature;
                document.getElementById('sensor1Humidity').textContent = `${data.sensor1.humidity.toFixed(1)}%`;
            }

            if (data.sensor2) {
                document.getElementById('sensor2Address').textContent = data.sensor2.address;
                document.getElementById('sensor2Temp').textContent = data.sensor2.temperature;
                document.getElementById('sensor2Humidity').textContent = `${data.sensor2.humidity.toFixed(1)}%`;
            }
        });

        // Handle safety state updates
        socket.on('safetyStateUpdate', (data) => {
            if (data) {
                currentSafetyState = data;
                updateSafetyUI();
            }
        });

        // Emergency stop event
        socket.on('emergencyStop', () => {
            console.log('Received emergencyStop event');
            currentSafetyState.emergency_stop = true;
            updateSafetyUI();
        });

        // Clear emergency stop event
        socket.on('clearEmergencyStop', () => {
            console.log('Received clearEmergencyStop event');
            currentSafetyState.emergency_stop = false;
            updateSafetyUI();
        });

        function updateSafetyUI() {
            console.log('Updating safety UI with state:', currentSafetyState);
            
            const emergencyButton = document.getElementById('emergencyButton');
            if (!emergencyButton) {
                console.log('Emergency button not found in DOM');
                return;
            }
            
            if (currentSafetyState && currentSafetyState.emergency_stop) {
                console.log('Setting UI to emergency state');
                emergencyButton.textContent = 'Clear Emergency';
                emergencyButton.classList.add('emergency-active');
                document.body.style.backgroundColor = 'var(--error-color)';
            } else {
                console.log('Setting UI to normal state');
                emergencyButton.textContent = 'Emergency Stop';
                emergencyButton.classList.remove('emergency-active');
                document.body.style.backgroundColor = 'var(--bg-primary)';
            }
        }

        socket.on('sensorData', (data) => {
            // Update system information
            document.getElementById('piUptime').textContent = data.system.piUptime;
            document.getElementById('serverUptime').textContent = data.system.serverUptime;
            document.getElementById('ipAddress').textContent = data.system.ipAddress;
            document.getElementById('macAddress').textContent = data.system.macAddress;
            document.getElementById('hostname').textContent = data.system.hostname;
            document.getElementById('cpuTemp').textContent = data.system.cpuTemp;

            // Update sensor 1 information
            document.getElementById('sensor1Address').textContent = data.sensor1.address;
            document.getElementById('sensor1Temp').textContent = data.sensor1.temperature;
            document.getElementById('sensor1Humidity').textContent = `${data.sensor1.humidity.toFixed(1)}%`;

            // Update sensor 2 information
            document.getElementById('sensor2Address').textContent = data.sensor2.address;
            document.getElementById('sensor2Temp').textContent = data.sensor2.temperature;
            document.getElementById('sensor2Humidity').textContent = `${data.sensor2.humidity.toFixed(1)}%`;
        });

        socket.on('systemState', function(data) {
            console.log('Received system state:', data);
            
            // Update modes
            document.getElementById('mode-auto').textContent = data.modes.automatic ? '1' : '0';
            document.getElementById('mode-emergency').textContent = data.modes.emergency ? '1' : '0';

            // Update manual PWM
            Object.entries(data.manualPwm).forEach(([pin, state]) => {
                const element = document.getElementById(`manual-${pin}`);
                if (element) {
                    element.textContent = `{${state.value}, ${state.enabled}}`;
                }
            });

            // Update automatic PWM
            Object.entries(data.autoPwm).forEach(([pin, value]) => {
                const element = document.getElementById(`auto-${pin}`);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update schedule
            console.log('Schedule data:', data.schedule);
            Object.entries(data.schedule).forEach(([pin, events]) => {
                console.log(`Processing pin ${pin}:`, events);
                const element = document.getElementById(`schedule-${pin}`);
                if (element) {
                    if (events.length === 0) {
                        element.textContent = '-';
                    } else {
                        element.innerHTML = events.map(event => 
                            `<div class="schedule-event ${event.enabled ? 'enabled' : 'disabled'}">
                                {"${event.time}", ${event.value}, ${event.enabled}}
                            </div>`
                        ).join('');
                    }
                }
            });
        });

        // Also update on state changes
        socket.on('stateUpdate', function() {
            socket.emit('getSystemState');
        });

        socket.on('modeUpdate', function() {
            socket.emit('getSystemState');
        });
    </script>
</body>
</html> 