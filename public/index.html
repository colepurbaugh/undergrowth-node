<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undergrowth Node</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="/assets/js/core.js"></script>
</head>
<body class="normal-state" style="background-image: url('/assets/backgrounds/undergrowth_logo.png') !important; background-repeat: no-repeat !important; background-position: top center !important; background-size: 90vh auto !important; background-attachment: fixed !important;">
    <div class="container">
        <div class="header-row">
            <h2 class="text-xl font-semibold mb-4 text-[#e8e6e3]" id="nodeHeader">System Information</h2>
            <button id="emergencyButton" class="emergency-button">Emergency Stop</button>
        </div>
        <div class="timezone-section">
            <div class="clock-display">
                <span id="dateDisplay"></span>
                <span id="timeDisplay"></span>
                <span id="timezoneDisplay"></span>
            </div>
            <div class="timezone-controls">
                <select id="timezoneSelect">
                    <!-- US Timezones -->
                    <option value="America/New_York">ET</option>
                    <option value="America/Chicago">CT</option>
                    <option value="America/Denver">MT</option>
                    <option value="America/Los_Angeles">PT</option>
                    <option value="America/Anchorage">AKT</option>
                    <option value="Pacific/Honolulu">HT</option>
                    <!-- UTC Offsets -->
                    <option value="UTC">UTC</option>
                    <option value="UTC+1">UTC+1</option>
                    <option value="UTC+2">UTC+2</option>
                    <option value="UTC+3">UTC+3</option>
                    <option value="UTC+4">UTC+4</option>
                    <option value="UTC+5">UTC+5</option>
                    <option value="UTC+6">UTC+6</option>
                    <option value="UTC+7">UTC+7</option>
                    <option value="UTC+8">UTC+8</option>
                    <option value="UTC+9">UTC+9</option>
                    <option value="UTC+10">UTC+10</option>
                    <option value="UTC+11">UTC+11</option>
                    <option value="UTC+12">UTC+12</option>
                    <option value="UTC-1">UTC-1</option>
                    <option value="UTC-2">UTC-2</option>
                    <option value="UTC-3">UTC-3</option>
                    <option value="UTC-4">UTC-4</option>
                    <option value="UTC-5">UTC-5</option>
                    <option value="UTC-6">UTC-6</option>
                    <option value="UTC-7">UTC-7</option>
                    <option value="UTC-8">UTC-8</option>
                    <option value="UTC-9">UTC-9</option>
                    <option value="UTC-10">UTC-10</option>
                    <option value="UTC-11">UTC-11</option>
                    <option value="UTC-12">UTC-12</option>
                </select>
                <button id="updateTimezone">Update Timezone</button>
            </div>
        </div>
    
        <div class="nav-buttons">
            <a href="/schedule" class="nav-button schedule">Schedule</a>
            <a href="/pwm" class="nav-button pwm">PWM</a>
            <a href="/graph" class="nav-button graph">Graph</a>
        </div>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Pi Uptime:</div>
                <div class="info-value" id="piUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Server Uptime:</div>
                <div class="info-value" id="serverUptime">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">IP Address:</div>
                <div class="info-value" id="ipAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">MAC Address:</div>
                <div class="info-value" id="macAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Hostname:</div>
                <div class="info-value" id="hostname">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">CPU Temperature:</div>
                <div class="info-value" id="cpuTemp">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Internet Status:</div>
                <div class="info-value" id="internetStatus">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Time Sync:</div>
                <div class="info-value" id="clockStatus">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">System Timezone:</div>
                <div class="info-value" id="systemTimezone">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Database Timezone:</div>
                <div class="info-value" id="databaseTimezone">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Sensors</h2>
        <div class="info-section">
            <div class="info-item">
                <h3>AHT10 Sensor <span id="sensor1Address">0x38</span></h3>
                <div class="sensor-data">
                    <div>Temperature: <span id="sensor1Temp">Loading...</span></div>
                    <div>Humidity: <span id="sensor1Humidity">Loading...</span></div>
                </div>
            </div>
            <div class="info-item">
                <h3>AHT10 Sensor <span id="sensor2Address">0x39</span></h3>
                <div class="sensor-data">
                    <div>Temperature: <span id="sensor2Temp">Loading...</span></div>
                    <div>Humidity: <span id="sensor2Humidity">Loading...</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>MQTT Broker Information</h2>
        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Connection Status:</div>
                <div class="info-value" id="brokerStatus">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Broker Address:</div>
                <div class="info-value" id="brokerAddress">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Broker Port:</div>
                <div class="info-value" id="brokerPort">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Connection:</div>
                <div class="info-value" id="brokerLastConnection">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Connection Duration:</div>
                <div class="info-value" id="brokerConnectionDuration">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Reconnection Attempts:</div>
                <div class="info-value" id="brokerReconnectionAttempts">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Last Message:</div>
                <div class="info-value" id="brokerLastMessage">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">Subscribed Topics:</div>
                <div class="info-value" id="brokerSubscribedTopics">Loading...</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentTimezone = 'America/Los_Angeles';
        
        // Define custom handler for initial state data
        function onInitialState(data) {
            // Update system information and other data
            if (data.system) {
                document.getElementById('piUptime').textContent = data.system.piUptime;
                document.getElementById('serverUptime').textContent = data.system.serverUptime;
                document.getElementById('ipAddress').textContent = data.system.ipAddress;
                document.getElementById('macAddress').textContent = data.system.macAddress;
                document.getElementById('hostname').textContent = data.system.hostname;
                document.getElementById('cpuTemp').textContent = data.system.cpuTemp;
                
                // Update header with hostname and IP address
                const hostname = data.system.hostname || '';
                const ipAddress = data.system.ipAddress || '';
                // Extract the last part of the hostname and the last octet of the IP
                const hostnameShort = hostname.split('-').pop() || '';
                const ipOctet = ipAddress.split('.').pop() || '';
                if (hostnameShort && ipOctet) {
                    document.getElementById('nodeHeader').textContent = `${hostnameShort}.${ipOctet}`;
                }
                
                // Update internet status with color coding
                const internetStatusElement = document.getElementById('internetStatus');
                if (internetStatusElement) {
                    internetStatusElement.textContent = data.system.internetStatus;
                    internetStatusElement.style.color = data.system.internetConnected ? 
                        'var(--success-color)' : 'var(--error-color)';
                }
                
                // Update clock status
                const clockStatusElement = document.getElementById('clockStatus');
                if (clockStatusElement) {
                    clockStatusElement.textContent = data.system.timeSinceSync;
                }
                
                // Update system timezone
                const systemTimezoneElement = document.getElementById('systemTimezone');
                if (systemTimezoneElement && data.system.systemTimezone) {
                    systemTimezoneElement.textContent = formatTimezoneDisplay(data.system.systemTimezone);
                }
            }
            
            // Update database timezone
            const databaseTimezoneElement = document.getElementById('databaseTimezone');
            if (databaseTimezoneElement && data.databaseTimezone) {
                databaseTimezoneElement.textContent = formatTimezoneDisplay(data.databaseTimezone);
            }

            if (data.sensor1) {
                document.getElementById('sensor1Address').textContent = data.sensor1.address;
                document.getElementById('sensor1Temp').textContent = data.sensor1.temperature;
                document.getElementById('sensor1Humidity').textContent = `${data.sensor1.humidity.toFixed(1)}%`;
            }

            if (data.sensor2) {
                document.getElementById('sensor2Address').textContent = data.sensor2.address;
                document.getElementById('sensor2Temp').textContent = data.sensor2.temperature;
                document.getElementById('sensor2Humidity').textContent = `${data.sensor2.humidity.toFixed(1)}%`;
            }
        }
        
        function updateClock() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZoneName: 'short'
            });
            
            const parts = formatter.formatToParts(now);
            const date = parts.find(p => p.type === 'month').value + ' ' +
                        parts.find(p => p.type === 'day').value + ' ' +
                        parts.find(p => p.type === 'year').value;
            const time = parts.find(p => p.type === 'hour').value + ':' +
                        parts.find(p => p.type === 'minute').value + ':' +
                        parts.find(p => p.type === 'second').value;
            const timezone = parts.find(p => p.type === 'timeZoneName').value;
            
            const dateDisplay = document.getElementById('dateDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            const timezoneDisplay = document.getElementById('timezoneDisplay');
            
            if (dateDisplay && timeDisplay && timezoneDisplay) {
                dateDisplay.textContent = date + ', ';
                timeDisplay.textContent = time;
                timezoneDisplay.textContent = ' (' + timezone + ')';
            }
        }

        // Custom initialization for this page
        function customInit() {
            // Update clock every second
            setInterval(updateClock, 1000);
            updateClock(); // Initial update

            // Request fresh system information periodically to catch system changes
            setInterval(() => {
                socket.emit('getInitialState');
            }, 30000); // Every 30 seconds

            // Timezone update button
            const updateTimezoneButton = document.getElementById('updateTimezone');
            if (updateTimezoneButton) {
                updateTimezoneButton.addEventListener('click', () => {
                    const timezoneSelect = document.getElementById('timezoneSelect');
                    if (timezoneSelect) {
                        const timezone = timezoneSelect.value;
                        socket.emit('setTimezone', { timezone });
                    }
                });
            }

            // Retrieve values button
            const retrieveValuesBtn = document.getElementById('retrieve-values-btn');
            if (retrieveValuesBtn) {
                retrieveValuesBtn.addEventListener('click', function() {
                    socket.emit('getSystemState');
                });
            }
            
            // Request timezone
            socket.emit('getTimezone');
        }

        // Handle timezone updates
        socket.on('timezoneUpdate', (data) => {
            const { timezone } = data;
            const timezoneSelect = document.getElementById('timezoneSelect');
            if (timezoneSelect) {
                timezoneSelect.value = timezone;
            }
            currentTimezone = timezone;
            updateClock();
        });

        socket.on('sensorData', (data) => {
            // Update system information
            document.getElementById('piUptime').textContent = data.system.piUptime;
            document.getElementById('serverUptime').textContent = data.system.serverUptime;
            document.getElementById('ipAddress').textContent = data.system.ipAddress;
            document.getElementById('macAddress').textContent = data.system.macAddress;
            document.getElementById('hostname').textContent = data.system.hostname;
            document.getElementById('cpuTemp').textContent = data.system.cpuTemp;
            
            // Update header with hostname and IP address
            const hostname = data.system.hostname || '';
            const ipAddress = data.system.ipAddress || '';
            // Extract the last part of the hostname and the last octet of the IP
            const hostnameShort = hostname.split('-').pop() || '';
            const ipOctet = ipAddress.split('.').pop() || '';
            if (hostnameShort && ipOctet) {
                document.getElementById('nodeHeader').textContent = `${hostnameShort}.${ipOctet}`;
            }
            
            // Update internet status with color coding
            const internetStatusElement = document.getElementById('internetStatus');
            if (internetStatusElement) {
                internetStatusElement.textContent = data.system.internetStatus;
                internetStatusElement.style.color = data.system.internetConnected ? 
                    'var(--success-color)' : 'var(--error-color)';
            }
            
            // Update clock status
            const clockStatusElement = document.getElementById('clockStatus');
            if (clockStatusElement) {
                clockStatusElement.textContent = data.system.timeSinceSync;
            }
            
            // Update system timezone
            const systemTimezoneElement = document.getElementById('systemTimezone');
            if (systemTimezoneElement && data.system.systemTimezone) {
                systemTimezoneElement.textContent = formatTimezoneDisplay(data.system.systemTimezone);
            }
            
            // Update database timezone
            const databaseTimezoneElement = document.getElementById('databaseTimezone');
            if (databaseTimezoneElement && data.databaseTimezone) {
                databaseTimezoneElement.textContent = formatTimezoneDisplay(data.databaseTimezone);
            }

            // Update sensor 1 information
            document.getElementById('sensor1Address').textContent = data.sensor1.address;
            document.getElementById('sensor1Temp').textContent = data.sensor1.temperature;
            document.getElementById('sensor1Humidity').textContent = `${data.sensor1.humidity.toFixed(1)}%`;

            // Update sensor 2 information
            document.getElementById('sensor2Address').textContent = data.sensor2.address;
            document.getElementById('sensor2Temp').textContent = data.sensor2.temperature;
            document.getElementById('sensor2Humidity').textContent = `${data.sensor2.humidity.toFixed(1)}%`;
        });

        socket.on('systemState', function(data) {
            // Update modes
            document.getElementById('mode-auto').textContent = data.modes.automatic ? '1' : '0';
            document.getElementById('mode-emergency').textContent = data.modes.emergency ? '1' : '0';

            // Update manual PWM
            Object.entries(data.manualPwm).forEach(([pin, state]) => {
                const element = document.getElementById(`manual-${pin}`);
                if (element) {
                    element.textContent = `{${state.value}, ${state.enabled}}`;
                }
            });

            // Update automatic PWM
            Object.entries(data.autoPwm).forEach(([pin, value]) => {
                const element = document.getElementById(`auto-${pin}`);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update schedule
            Object.entries(data.schedule).forEach(([pin, events]) => {
                const element = document.getElementById(`schedule-${pin}`);
                if (element) {
                    if (events.length === 0) {
                        element.textContent = '-';
                    } else {
                        element.innerHTML = events.map(event => 
                            `<div class="schedule-event ${event.enabled ? 'enabled' : 'disabled'}">
                                {"${event.time}", ${event.value}, ${event.enabled}}
                            </div>`
                        ).join('');
                    }
                }
            });
        });

        // Also update on state changes
        socket.on('stateUpdate', function() {
            socket.emit('getSystemState');
        });

        socket.on('modeUpdate', function() {
            socket.emit('getSystemState');
        });
        
        // Update sensor readings
        socket.on('sensor1', (data) => {
            document.getElementById('sensor1Address').textContent = data.address;
            document.getElementById('sensor1Temp').textContent = data.temperature;
            document.getElementById('sensor1Humidity').textContent = data.humidity;
        });
        
        socket.on('sensor2', (data) => {
            document.getElementById('sensor2Address').textContent = data.address;
            document.getElementById('sensor2Temp').textContent = data.temperature;
            document.getElementById('sensor2Humidity').textContent = data.humidity;
        });

        // Update broker information
        socket.on('brokerInfo', (data) => {
            const statusElement = document.getElementById('brokerStatus');
            statusElement.textContent = data.connected ? 'Connected' : 'Disconnected';
            statusElement.style.color = data.connected ? 'var(--success-color)' : 'var(--error-color)';
            
            document.getElementById('brokerAddress').textContent = data.address || 'Not connected';
            document.getElementById('brokerPort').textContent = data.port || 'Not connected';
            
            // Format dates with timezone
            const formatDate = (date) => {
                if (!date) return 'Never';
                return new Date(date).toLocaleString('en-US', {
                    timeZone: currentTimezone,
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZoneName: 'short'
                });
            };
            
            document.getElementById('brokerLastConnection').textContent = formatDate(data.lastConnection);
            document.getElementById('brokerConnectionDuration').textContent = data.connectionDuration;
            document.getElementById('brokerReconnectionAttempts').textContent = data.reconnectionAttempts || '0';
            document.getElementById('brokerLastMessage').textContent = formatDate(data.lastMessage);
            document.getElementById('brokerSubscribedTopics').textContent = data.subscribedTopics ? data.subscribedTopics.join(', ') : 'None';
        });
        
        // Initialize the application
        initializeApp(socket, customInit);
    </script>
</body>
</html> 