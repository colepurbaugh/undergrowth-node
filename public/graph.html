<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data Graphs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-[#181a1b] p-4">
    <div class="w-full">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-[#e8e6e3]">Sensor Data Graphs</h1>
            <div class="flex items-center gap-2">
                <select id="timezone" class="rounded-md border-gray-500 bg-[#181a1b] text-[#e8e6e3]">
                    <option value="America/Los_Angeles">Pacific (PDT/PST)</option>
                    <option value="America/Denver">Mountain (MDT/MST)</option>
                    <option value="America/Chicago">Central (CDT/CST)</option>
                    <option value="America/New_York">Eastern (EDT/EST)</option>
                </select>
                <div id="currentTime" class="text-lg text-[#e8e6e3]"></div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="bg-[#333] p-4 rounded shadow mb-4">
            <div class="flex flex-wrap gap-4 items-end justify-between">
                <div class="flex gap-4">
                    <div>
                        <label for="timeRange" class="block text-sm font-medium text-[#e8e6e3]">Time Range:</label>
                        <select id="timeRange" class="mt-1 block w-full rounded-md border-gray-500 bg-[#181a1b] text-[#e8e6e3]">
                            <option value="1">Last Hour</option>
                            <option value="24">Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div>
                        <label for="points" class="block text-sm font-medium text-[#e8e6e3]">Points:</label>
                        <select id="points" class="mt-1 block w-full rounded-md border-gray-500 bg-[#181a1b] text-[#e8e6e3]">
                            <option value="100">100 points</option>
                            <option value="1000" selected>1000 points</option>
                            <option value="10000">10000 points</option>
                        </select>
                    </div>
                </div>
                <button id="updateButton" class="px-4 py-2 bg-green-600 text-[#e8e6e3] rounded-md hover:bg-green-700 transition-colors">
                    Update
                </button>
            </div>
        </div>

        <!-- Temperature Chart -->
        <div class="bg-[#333] p-4 rounded shadow mb-4">
            <h2 class="text-xl font-semibold mb-2 text-[#e8e6e3]">Temperature (°F)</h2>
            <div class="chart-container" style="height: 300px;">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="bg-[#333] p-4 rounded shadow">
            <h2 class="text-xl font-semibold mb-2 text-[#e8e6e3]">Humidity (%)</h2>
            <div class="chart-container" style="height: 300px;">
                <canvas id="humidityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let tempChart = null;
        let humidityChart = null;
        let autoUpdateInterval = null;

        // Get timezone from localStorage or default to local timezone
        const defaultTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const savedTimezone = localStorage.getItem('selectedTimezone') || defaultTimezone;
        document.getElementById('timezone').value = savedTimezone;

        function updateTime() {
            const timezone = document.getElementById('timezone').value;
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: true
            });
            const timeString = formatter.format(now);
            const timezoneAbbr = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                timeZoneName: 'short'
            }).formatToParts(now).find(part => part.type === 'timeZoneName').value;
            document.getElementById('currentTime').textContent = `${timeString} ${timezoneAbbr}`;
        }

        function updateCharts() {
            console.log('Updating charts...');
            const timeRange = document.getElementById('timeRange').value;
            const points = document.getElementById('points').value;
            const timezone = document.getElementById('timezone').value;
            const now = new Date();
            const startDate = new Date(now.getTime() - (timeRange * 3600 * 1000)).toISOString();

            console.log('Fetching data with params:', {
                startDate,
                hours: timeRange,
                points,
                timezone
            });

            // Update temperature chart
            fetch(`/api/readings/binned?startDate=${startDate}&hours=${timeRange}&points=${points}&type=temperature`)
                .then(response => response.json())
                .then(data => {
                    console.log('Temperature data received:', data.length, 'points');
                    const formattedData = data.map(row => ({
                        ...row,
                        timestamp: new Date(row.timestamp).toLocaleString('en-US', { timeZone: timezone })
                    }));
                    updateChart(tempChart, formattedData, 'Temperature (°F)', 'rgb(255, 99, 132)');
                })
                .catch(error => console.error('Error fetching temperature data:', error));

            // Update humidity chart
            fetch(`/api/readings/binned?startDate=${startDate}&hours=${timeRange}&points=${points}&type=humidity`)
                .then(response => response.json())
                .then(data => {
                    console.log('Humidity data received:', data.length, 'points');
                    const formattedData = data.map(row => ({
                        ...row,
                        timestamp: new Date(row.timestamp).toLocaleString('en-US', { timeZone: timezone })
                    }));
                    updateChart(humidityChart, data, 'Humidity (%)', 'rgb(54, 162, 235)');
                })
                .catch(error => console.error('Error fetching humidity data:', error));
        }

        function updateChart(chart, data, label, color) {
            const labels = data.map(row => row.timestamp);
            const values = data.map(row => row.value);

            if (!chart) {
                const ctx = document.getElementById(label.includes('Temperature') ? 'tempChart' : 'humidityChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: values,
                            borderColor: color,
                            backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e8e6e3'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#e8e6e3'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#e8e6e3'
                                },
                                title: {
                                    display: true,
                                    text: label,
                                    color: '#e8e6e3'
                                }
                            }
                        }
                    }
                });
            } else {
                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
            }

            return chart;
        }

        // Initialize charts and time display
        document.addEventListener('DOMContentLoaded', () => {
            // Update time every second
            updateTime();
            setInterval(updateTime, 1000);
            
            // Save timezone selection
            document.getElementById('timezone').addEventListener('change', (e) => {
                localStorage.setItem('selectedTimezone', e.target.value);
                updateTime();
                updateCharts();
            });
            
            // Initial chart update
            updateCharts();
            
            // Update charts when controls change
            document.getElementById('timeRange').addEventListener('change', () => {
                clearInterval(autoUpdateInterval);
                updateCharts();
                if (document.getElementById('timeRange').value === '1') {
                    autoUpdateInterval = setInterval(updateCharts, 5000);
                }
            });

            document.getElementById('points').addEventListener('change', updateCharts);
            
            // Add click handler for Update button
            document.getElementById('updateButton').addEventListener('click', () => {
                console.log('Update button clicked');
                updateCharts();
            });
        });
    </script>
</body>
</html> 