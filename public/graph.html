<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sensor Data Graphs</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-primary: #181a1b;
            --text-primary: #e8e6e3;
            --text-secondary: #b2aba1;
            --border-color: #736b5e;
            --success-color: #3d8c40;
            --error-color: #a91409;
            --active-color: #998100;
            --inactive-color: #4f5559;
            --selection-bg: #004daa;
            --selection-text: #e8e6e3;
            --emergency-color: #ff8c00;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--bg-primary);
            background-image: url('/assets/backgrounds/undergrowth_logo.png');
            background-repeat: no-repeat;
            background-position: top center;
            background-size: 90vh auto;
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 1rem;
            min-height: 100vh;
        }

        .container {
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .controls {
            background-color: #333;
            opacity: 0.8;
            padding: 1rem;
            border-radius: 0.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            justify-content: space-between;
        }

        .controls-group {
            display: flex;
            gap: 1rem;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        select {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .update-button {
            padding: 0.5rem 1rem;
            background-color: var(--success-color);
            color: var(--text-primary);
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .update-button:hover {
            background-color: #2d6c30;
        }

        .chart-container {
            background-color: #333;
            opacity: 0.8;
            padding: 1rem;
            border-radius: 0.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .chart-canvas {
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Sensor Data Graphs</h1>
            <div class="time-container">
                <div id="currentTime" class="time-display"></div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div class="controls-container">
                <div class="controls-group">
                    <div>
                        <label for="timeRange" class="control-label">Time Range:</label>
                        <select id="timeRange">
                            <option value="1">Last Hour</option>
                            <option value="24">Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div>
                        <label for="points" class="control-label">Points:</label>
                        <select id="points">
                            <option value="100">100 points</option>
                            <option value="1000" selected>1000 points</option>
                            <option value="10000">10000 points</option>
                        </select>
                    </div>
                </div>
                <button id="updateButton" class="update-button">
                    Update
                </button>
            </div>
        </div>

        <!-- Temperature Chart -->
        <div class="chart-container">
            <h2 class="chart-title">Temperature (°F)</h2>
            <div class="chart-canvas">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="chart-container">
            <h2 class="chart-title">Humidity (%)</h2>
            <div class="chart-canvas">
                <canvas id="humidityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let tempChart = null;
        let humidityChart = null;
        let autoUpdateInterval = null;
        let currentTimezone = 'America/Los_Angeles'; // Default, will be updated from server

        // Initialize socket connection
        const socket = io();

        // Get timezone from server on connect
        socket.on('connect', () => {
            socket.emit('getTimezone');
        });

        // Handle timezone updates from server
        socket.on('timezoneUpdate', (data) => {
            currentTimezone = data.timezone;
            updateTime();
        });

        function updateTime() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: true
            });
            const timeString = formatter.format(now);
            const timezoneAbbr = new Intl.DateTimeFormat('en-US', {
                timeZone: currentTimezone,
                timeZoneName: 'short'
            }).formatToParts(now).find(part => part.type === 'timeZoneName').value;
            document.getElementById('currentTime').textContent = `${timeString} ${timezoneAbbr}`;
        }

        function fetchAndUpdateChart(url, type) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(`${type} data received:`, data.length, 'points');
                    const formattedData = data.map(row => ({
                        ...row,
                        timestamp: new Date(row.timestamp).toLocaleString('en-US', { timeZone: currentTimezone })
                    }));
                    
                    // Destroy existing chart if it exists
                    if (type === 'temperature' && tempChart) {
                        tempChart.destroy();
                    } else if (type === 'humidity' && humidityChart) {
                        humidityChart.destroy();
                    }

                    // Create new chart
                    const ctx = document.getElementById(type === 'temperature' ? 'tempChart' : 'humidityChart').getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: formattedData.map(row => row.timestamp),
                            datasets: [{
                                label: type === 'temperature' ? 'Temperature (°F)' : 'Humidity (%)',
                                data: formattedData.map(row => row.value),
                                borderColor: type === 'temperature' ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)',
                                backgroundColor: type === 'temperature' ? 'rgba(255, 99, 132, 0.1)' : 'rgba(54, 162, 235, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#e8e6e3'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#e8e6e3'
                                    }
                                },
                                y: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#e8e6e3'
                                    },
                                    title: {
                                        display: true,
                                        text: type === 'temperature' ? 'Temperature (°F)' : 'Humidity (%)',
                                        color: '#e8e6e3'
                                    }
                                }
                            }
                        }
                    });

                    // Store reference to the new chart
                    if (type === 'temperature') {
                        tempChart = chart;
                    } else {
                        humidityChart = chart;
                    }
                })
                .catch(error => console.error(`Error fetching ${type} data:`, error));
        }

        function updateCharts() {
            const timeRange = document.getElementById('timeRange').value;
            const points = document.getElementById('points').value;
            const now = new Date();
            const startDate = new Date(now.getTime() - (timeRange * 3600 * 1000)).toISOString();

            // Build URLs for both charts
            const tempUrl = new URL('/api/readings/binned', window.location.origin);
            tempUrl.searchParams.set('startDate', startDate);
            tempUrl.searchParams.set('hours', timeRange);
            tempUrl.searchParams.set('points', points);
            tempUrl.searchParams.set('type', 'temperature');

            const humidityUrl = new URL('/api/readings/binned', window.location.origin);
            humidityUrl.searchParams.set('startDate', startDate);
            humidityUrl.searchParams.set('hours', timeRange);
            humidityUrl.searchParams.set('points', points);
            humidityUrl.searchParams.set('type', 'humidity');

            // Fetch and update both charts
            fetchAndUpdateChart(tempUrl, 'temperature');
            fetchAndUpdateChart(humidityUrl, 'humidity');
        }

        // Initial update
        updateTime();
        setInterval(updateTime, 1000);
        updateCharts();

        // Add click handler for Update button
        document.getElementById('updateButton').addEventListener('click', updateCharts);

        // Add change handlers for time range and points
        document.getElementById('timeRange').addEventListener('change', updateCharts);
        document.getElementById('points').addEventListener('change', updateCharts);
    </script>
</body>
</html> 